{"author":{"id":"MDQ6VXNlcjM0OTM4ODE3","is_bot":false,"login":"conorcraig","name":""},"baseRefName":"main","body":"## Summary\n\nThis PR advances Issue #70 (Orchestrated multi-agent teams) while keeping the system single-agent-typed. Any agent instance can orchestrate by calling tools; no separate orchestrator class is introduced.\n\n## Scope and Design\n\n- Single agent type; orchestration is behavior via tools:\n  - `chat_send`: spawns sub-agents as new conversations of the same agent.\n  - `signals`: coordinates phase gates and completion without ending turns.\n  - `TeamRegistry`: assigns responsibilities and allowed path scopes.\n  - `Branch allocation`: per-child branch (no worktrees).\n- Observability: signal send/recv events and existing stream events (token/tool_step/output).\n\n## Changes\n\n- Teaming\n  - Add `magent2/team/registry.py`: in-memory team registry, window person, path ownership.\n  - Add `magent2/team/branch.py`: safe branch allocator (`feature/{ticket}/{agent}`).\n- Signals and child completion\n  - Worker optional auto-complete: when child receives `done_topic=...` hint and `AUTO_CHILD_SIGNAL_DONE=1`, it emits a `signal:...:done`.\n- Orchestration helper\n  - Add `magent2/tools/orchestrate.py`:\n    - `orchestrate_split(task, num_children, ...)` publishes subtask kickoffs to `agent:DevAgent`, encodes hints in message content, and can `wait` on `signal_wait_all`.\n    - Function-tool wrapper `orchestrate_split_tool` is behind `ENABLE_ORCHESTRATE_TOOL=1` to avoid SDK schema conflicts during tests.\n- Chat tool\n  - Kept public SDK function signature stable; orchestration hints are encoded in content when needed.\n- Demo/Responses runner\n  - Added a minimal OpenAI Responses runner (unused unless Agents runner is unavailable); guarded by selection logic. No impact on existing tests.\n\n## Environment Flags\n\n- `AUTO_CHILD_SIGNAL_DONE=1`: enable child auto \"done\" signal when `done_topic=...` is found in the message text.\n- `ENABLE_ORCHESTRATE_TOOL=1`: register `orchestrate_split_tool` as an Agents SDK function tool.\n\n## What’s NOT in scope\n\n- No separate orchestrator class; behavior is expressed via tool calls.\n- Web search integration is unchanged (left optional as per PRD).\n\n## Tests\n\n- New:\n  - Team registry: `tests/test_team_registry.py`.\n  - Branch allocator: `tests/test_branch_allocator.py`.\n- Existing suites all pass locally (ruff, mypy, pytest). CI should remain green.\n\n## Risks and Mitigations\n\n- Tool schema compatibility: the orchestrate function tool is env-gated to avoid breaking the SDK function schema during tests.\n- Child auto-signal parsing: guarded by env and conservative; only triggers if `done_topic=` is present.\n\n## Reviewer Checklist\n\n- [ ] Validate that orchestration approach aligns with Issue #70 (single agent type orchestrating via tools).\n- [ ] Confirm tests pass and CI is green.\n- [ ] Review `TeamRegistry` path ownership semantics (glob specificity).\n- [ ] Review branch naming/creation safety.\n- [ ] Consider documentation follow-ups (quickstart for orchestration flags, demo instructions).","comments":[{"id":"IC_kwDOPrGkDs7DRaO7","author":{"login":"cursor"},"authorAssociation":"NONE","body":"Cursor Agent can help with this pull request. Just `@cursor` in comments and I'll start working on changes in this branch.\n<sub>[Learn more](https://docs.cursor.com/background-agent/web-and-mobile) about Cursor Agents</sub>","createdAt":"2025-09-10T18:43:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/conorcraig/magent2/pull/110#issuecomment-3276121019","viewerDidAuthor":false},{"id":"IC_kwDOPrGkDs7EAp4M","author":{"login":"conorcraig"},"authorAssociation":"OWNER","body":"### Requested changes to land this PR\n\n- [ ] Rebase to resolve DIRTY merge state (branch is not cleanly mergeable).\n- [ ] Remove committed log file `openai_runner.log` and ignore logs (e.g., add `*.log` to `.gitignore`).\n- [ ] Fix CI by setting local git identity in the temp repo before the first commit in `tests/test_branch_allocator.py`:\n```python\nassert _run([\"git\", \"config\", \"user.email\", \"test@example.com\"], str(repo)) == 0\nassert _run([\"git\", \"config\", \"user.name\", \"Test User\"], str(repo)) == 0\n```\n- [ ] Orchestration hints: use structured metadata instead of encoding in message content.\n  - In `orchestrate_split`, send:\n```python\nsend_message(\n  f\"agent:{target}\",\n  f\"Subtask for: {task}\",\n  conversation_id=conv,\n  metadata={\n    \"orchestrate\": {\n      \"responsibilities\": responsibilities or [],\n      \"allowed_paths\": allowed_paths or [],\n      \"done_topic\": topic,\n    }\n  },\n)\n```\n  - In `Worker`, read and validate before signaling:\n```python\nmeta = envelope.metadata or {}\norch = meta.get(\"orchestrate\") if isinstance(meta, dict) else None\ntopic = (orch or {}).get(\"done_topic\") if isinstance(orch, dict) else None\nif isinstance(topic, str) and topic.startswith(\"signal:\") and len(topic) <= 256:\n    send_signal(topic, {\"ok\": True})\n```\n- [ ] Decouple the target agent in `orchestrate_split` (avoid hard-coded `agent:DevAgent`).\n  - Accept `target_agent` param; fallback to `ORCHESTRATE_TARGET_AGENT` or `AGENT_NAME`.\n- [ ] Make wait timeout configurable (e.g., `timeout_ms: int = 30000`) and thread into `signal_wait_all`.\n- [ ] Tests to add/adjust:\n  - Unit test for `orchestrate_split` using a stub Bus to assert conversation + agent topics and metadata propagation.\n  - Unit test for auto \"done\" path using metadata-driven `done_topic` (monkeypatch `send_signal`).\n\nDirection is aligned with the PRD (single agent orchestrates via tools). The above changes will make it robust and CI-friendly. Ping when pushed and I’ll re-check CI.","createdAt":"2025-09-13T15:09:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/conorcraig/magent2/pull/110#issuecomment-3288505868","viewerDidAuthor":true}],"commits":[{"authoredDate":"2025-09-10T18:43:23Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-10T18:43:23Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"feat: Add team registry and worktree allocation","oid":"9cdccddb3f72b3123f3c986085bb12ed5240f018"},{"authoredDate":"2025-09-10T18:45:32Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-10T18:45:32Z","messageBody":"The worktree allocation logic is no longer needed and has been removed.\n\nCo-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"Remove unused worktree functionality","oid":"1f91494a23ee62d14efbd7ed08fc346e07e1b8dc"},{"authoredDate":"2025-09-10T19:44:05Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-10T19:44:05Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"feat: Add DemoRunner and Git branch allocation","oid":"3f8f20d7bb113fd378690c5d5808f801869a370b"},{"authoredDate":"2025-09-11T07:09:51Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-11T07:09:51Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"Add demo conversation log for 10 turns","oid":"4a27579f3f80c34b9bdafcbc7612992030292220"},{"authoredDate":"2025-09-11T07:17:08Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-11T07:17:08Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"Checkpoint before follow-up message","oid":"bb8d2a44282dbb78efbf27696da0ccb25b7fe869"},{"authoredDate":"2025-09-11T07:29:55Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-11T07:29:55Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"Add demo conversation log","oid":"783b4e67596fe4d84ae3edf0ace3949666131c37"},{"authoredDate":"2025-09-11T07:38:08Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-11T07:38:08Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"Feat: Add initial Uvicorn server logs","oid":"df824dc105993854b5e8eacab19e9c9182461515"},{"authoredDate":"2025-09-11T08:07:20Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-11T08:07:20Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"feat: Add OpenAIResponsesRunner for direct API calls","oid":"b8eecbbd70e9e20f8aa7ca1267e41d51a1bd8052"},{"authoredDate":"2025-09-13T12:47:18Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-13T12:47:18Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"feat: Add orchestrate_split tool and metadata to send_message","oid":"84322b52856603a223c11a90e1ffd77f96be26bf"},{"authoredDate":"2025-09-13T12:57:16Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-13T12:57:16Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"Refactor: Add auto child signal done behavior","oid":"8822fc50def4f0525811c3be51f85f03e92b5969"},{"authoredDate":"2025-09-13T13:10:09Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-13T13:10:09Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"feat: Implement orchestrated multi-agent teams via tools","oid":"d9557de68a99658c10c2457e218b2ff8d0adb9de"},{"authoredDate":"2025-09-13T14:38:21Z","authors":[{"email":"34938817+conorcraig@users.noreply.github.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conorcraig"}],"committedDate":"2025-09-13T14:38:21Z","messageBody":"…rable timeout","messageHeadline":"feat(orchestrate): structured metadata, parameterized target, configu…","oid":"6aa8a2194b46a8d732f01d2723ea2c1724cb2d8e"},{"authoredDate":"2025-09-13T14:58:41Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-13T14:58:41Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"Refactor done_topic signal handling to prefer metadata","oid":"bf2484b380859a160346ed27efceefd58e093765"},{"authoredDate":"2025-09-13T15:01:56Z","authors":[{"email":"cursoragent@cursor.com","id":"U_kgDOC972lw","login":"cursoragent","name":"Cursor Agent"},{"email":"conor.craig@outlook.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conor.craig"}],"committedDate":"2025-09-13T15:01:56Z","messageBody":"Co-authored-by: conor.craig <conor.craig@outlook.com>","messageHeadline":"Refactor worker to simplify done_topic detection","oid":"7f3ae016fc6a77dd6f650b0b387f4b6ac4e2a015"},{"authoredDate":"2025-09-13T15:07:07Z","authors":[{"email":"34938817+conorcraig@users.noreply.github.com","id":"MDQ6VXNlcjM0OTM4ODE3","login":"conorcraig","name":"conorcraig"}],"committedDate":"2025-09-13T15:07:07Z","messageBody":"…and-pass-ci-e8be","messageHeadline":"Merge branch 'main' into cursor/setup-environment-implement-issue-70-…","oid":"b81964989ade946c2c2ee122f28eb64cc79b06ff"}],"files":[{"path":".agent_instructions.txt","additions":2,"deletions":0},{"path":"PR_DESCRIPTION.md","additions":58,"deletions":0},{"path":"magent2/runner/demo_runner.py","additions":65,"deletions":0},{"path":"magent2/runner/openai_responses_runner.py","additions":38,"deletions":0},{"path":"magent2/team/__init__.py","additions":11,"deletions":0},{"path":"magent2/team/branch.py","additions":67,"deletions":0},{"path":"magent2/team/registry.py","additions":162,"deletions":0},{"path":"magent2/tools/chat/function_tools.py","additions":4,"deletions":3},{"path":"magent2/tools/orchestrate.py","additions":92,"deletions":0},{"path":"magent2/worker/__main__.py","additions":27,"deletions":0},{"path":"magent2/worker/worker.py","additions":22,"deletions":0},{"path":"openai_runner.log","additions":5,"deletions":0},{"path":"tests/test_branch_allocator.py","additions":39,"deletions":0},{"path":"tests/test_team_registry.py","additions":38,"deletions":0}],"headRefName":"cursor/setup-environment-implement-issue-70-and-pass-ci-e8be","number":110,"reviews":[{"id":"PRR_kwDOPrGkDs6_9-Bz","author":{"login":"cursor"},"authorAssociation":"NONE","body":"### This PR is being reviewed by Cursor Bugbot\n\n<details>\n<summary>Details</summary>\n\nYou are on the Bugbot Free tier. On this plan, Bugbot will review limited PRs each billing cycle.\n\nTo receive Bugbot reviews on all of your PRs, please upgrade to Bugbot Pro by visiting the [Cursor dashboard](https://www.cursor.com/dashboard?tab=bugbot). Your first 14 days will be free!\n</details>\n\n","submittedAt":"2025-09-13T13:09:37Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED","commit":{"oid":"8822fc50def4f0525811c3be51f85f03e92b5969"}},{"id":"PRR_kwDOPrGkDs6_-5Li","author":{"login":"cursor"},"authorAssociation":"NONE","body":"","submittedAt":"2025-09-13T14:41:09Z","includesCreatedEdit":false,"reactionGroups":[],"state":"COMMENTED","commit":{"oid":"6aa8a2194b46a8d732f01d2723ea2c1724cb2d8e"}}],"title":"Issue #70: Single-agent orchestration via tools (signals, registry, branches)","url":"https://github.com/conorcraig/magent2/pull/110"}
